@model List<EWOS_MVC.Models.ItemRequestModel>
@{
    ViewData["Title"] = "Dashboard";
}
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h5 class="my-3">Riwayat Request</h5>

<div class="d-flex align-items-center mb-3 gap-2">
    <div class="col-2 col-sm-2">
        @await Component.InvokeAsync("MachineCategories")
    </div>
    <input type="text" id="searchBox" class="form-control" placeholder="Search..." aria-label="Search" style="max-width: 300px;">
</div>
<style>
    .tab-wrapper {
        max-width: auto;
        position: relative;
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 1rem;
    }

    .nav-tabs {
        border: none;
        margin-bottom: 0;
    }

        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            background-color: transparent;
            font-weight: 500;
            position: relative;
        }

            .nav-tabs .nav-link.active {
                color: #0d6efd;
                border-bottom: 3px solid #0d6efd;
                background-color: transparent;
            }

            .nav-tabs .nav-link:hover {
                color: #0d6efd;
            }

    .nav-link .badge {
        font-size: 0.75rem;
        margin-left: 6px;
        vertical-align: middle;
    }
</style>


@{
    var summary = ViewBag.StatusSummary as Dictionary<string, int>;
    int GetCount(string status) => summary != null && summary.ContainsKey(status) ? summary[status] : 0;
}

<ul class="nav nav-tabs justify-content-center" id="statusTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active"
                id="waitingapproval-tab"
                data-bs-toggle="tab"
                data-bs-target="#waitingapproval"
                data-status="WaitingApproval"
                type="button"
                role="tab">
            Waiting Approve
            @if (GetCount("WaitingApproval") > 0)
            {
                <span class="badge bg-danger rounded-pill">@GetCount("WaitingApproval")</span>
            }
        </button>
    </li>

    <li class="nav-item" role="presentation">
        <button class="nav-link"
                id="waitingfabrication-tab"
                data-bs-toggle="tab"
                data-bs-target="#waitingfabrication"
                data-status="WaitingFabrication"
                type="button"
                role="tab">
            Waiting Fabrication
            @if (GetCount("WaitingFabrication") > 0)
            {
                <span class="badge bg-danger rounded-pill">@GetCount("WaitingFabrication")</span>
            }
        </button>
    </li>

    <li class="nav-item" role="presentation">
        <button class="nav-link"
                id="onfabrication-tab"
                data-bs-toggle="tab"
                data-bs-target="#onfabrication"
                data-status="InFabrication"
                type="button"
                role="tab">
            In Fabrication
            @if (GetCount("InFabrication") > 0)
            {
                <span class="badge bg-danger rounded-pill">@GetCount("InFabrication")</span>
            }
        </button>
    </li>

    <li class="nav-item" role="presentation">
        <button class="nav-link"
                id="waitingconfirmation-tab"
                data-bs-toggle="tab"
                data-bs-target="#waitingconfirmation"
                data-status="WaitingConfirmation"
                type="button"
                role="tab">
            Waiting Buyoff
            @if (GetCount("WaitingConfirmation") > 0)
            {
                <span class="badge bg-danger rounded-pill">@GetCount("WaitingConfirmation")</span>
            }
        </button>
    </li>

    <li class="nav-item" role="presentation">
        <button class="nav-link"
                id="history-tab"
                data-bs-toggle="tab"
                data-bs-target="#history"
                data-status="Maspro,Fail"
                type="button"
                role="tab">
            History
            @{
                int historyCount = GetCount("Maspro") + GetCount("Fail");
            }
            @if (historyCount > 0)
            {
                <span class="badge bg-danger rounded-pill">@historyCount</span>
            }
        </button>
    </li>


    <li class="nav-item" role="presentation">
        <button class="nav-link"
                id="reject-tab"
                data-bs-toggle="tab"
                data-bs-target="#reject"
                data-status="Reject"
                type="button"
                role="tab">
            Reject
            @if (GetCount("Reject") > 0)
            {
                <span class="badge bg-danger rounded-pill">@GetCount("Reject")</span>
            }
        </button>
    </li>
</ul>

<table class="table table-sm mt-3 table-striped table-bordered">
    <thead>
        <tr>
            <th class="text-center">No</th>
            <th>ID Request</th>
            <th>Item Name</th>
            <th>Machine Category</th>
            <th>Request Date</th>

            <th class="text-center">Action</th>
        </tr>
    </thead>
    <tbody>
        @{
            int index = 1;
        }

        @if (Model == null || !Model.Any())
        {
            <tr>
                <td colspan="12" class="text-center text-muted">Tidak ada data.</td>
            </tr>
        }
        else
        {
            foreach (var ir in Model)
            {
                <tr>
                    <td class="text-center">@index</td>
                    <td>@ir.Id</td>
                    <td>@ir.PartName</td>
                    <td>@ir.MachineCategories?.CategoryName</td>
                    <td>@ir.CreatedAt</td>
                    <td class="text-center">
                        @if (ir.Status == "WaitingConfirmation")
                        {
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalPass-@ir.Id">
                                <i class="bi bi-check"></i> Pass
                            </button>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalFail-@ir.Id">
                                <i class="bi bi-x-lg"></i> Fail
                            </button>

                        }
                        <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalDetail-@ir.Id">
                            <i class="bi bi-info-circle"></i> Detail
                        </button>
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalStatus-@ir.Id">
                            <i class="bi bi-ticket-detailed"></i> Status
                        </button>
                    </td>
                </tr>
                index++;
            }
        }

    </tbody>
</table>

<!-- Modal pass -->
@if (ViewBag.ModalData != null)
{
    foreach (var ir in (IEnumerable<dynamic>)ViewBag.ModalData)
    {
        <div class="modal fade" id="modalPass-@ir.Id" tabindex="-1" aria-labelledby="modalApprove" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="post" action="/Requestor/MyRequest/Pass" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <div class="modal-header bg-success">
                            <h5 class="modal-title mb-2 text-white" id="modalApprove">Confirmation Result</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="my-2">Id Request</label>
                                <input class="form-control" value="@ir.Id" readonly />
                            </div>
                            <div class="form-group">
                                <label class="my-2">Item Name</label>
                                <input type="hidden" name="ItemRequestId" value="@ir.Id" />
                                <input name="PartName" class="form-control" value="@ir.PartName" readonly />
                            </div>
                            <div class="form-group">
                                <label class="my-2">Result</label>
                                <input class="form-control" value="Pass" readonly />
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="submit" class="btn btn-success">Lanjut</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }
}

<nav aria-label="Page navigation example">
    <ul class="pagination justify-content-end">
        <li class="page-item disabled">
            <a class="page-link">Previous</a>
        </li>
        <li class="page-item"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item">
            <a class="page-link" href="#">Next</a>
        </li>
    </ul>
</nav>

<!-- Modal Fail -->
@if (ViewBag.ModalData != null)
{
    foreach (var ir in (IEnumerable<dynamic>)ViewBag.ModalData)
    {
        <div class="modal fade" id="modalFail-@ir.Id" tabindex="-1" aria-labelledby="modalApprove" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form method="post" action="/Requestor/MyRequest/Fail" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <div class="modal-header bg-danger">
                            <h5 class="modal-title mb-2 text-white" id="modalApprove">Confirmation Result</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="my-2" asp-for="ItemRequestId">Id Request</label>
                                <input class="form-control" value="@ir.Id" readonly />
                                <span asp-validation-for="PartName" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label class="my-2" asp-for="ItemRequestId">Item Name</label>
                                <input type="hidden" name="ItemRequestId" value="@ir.Id" />
                                <input name="PartName" class="form-control" value="@ir.PartName" readonly />
                                <span asp-validation-for="PartName" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label class="my-2" asp-for="ItemRequestId">Result</label>
                                <input class="form-control" value="Fail" readonly />
                                <span asp-validation-for="PartName" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label class="my-2" asp-for="ItemRequestId">Reason</label>
                                <textarea class="form-control" id="Reason" name="Reason" rows="3" placeholder="Input Reason..."></textarea>
                                <span asp-validation-for="SapId" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="submit" class="btn btn-danger">Lanjut</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    }
}
@if (ViewBag.ModalData != null)
{
    foreach (var rm in (IEnumerable<dynamic>)ViewBag.ModalData)
    {
        // cek apakah status terakhir reject
        var isRejected = rm.Status?.ToString().Equals("Reject", StringComparison.OrdinalIgnoreCase) == true;


        var latestReject = (rm.RequestStatus as IEnumerable<dynamic>)?
            .FirstOrDefault(s =>
                s.Status != null && s.Status.ToString().Contains("Reject", StringComparison.OrdinalIgnoreCase)
            );

        <div class="modal fade" id="modalStatus-@rm.Id" tabindex="-1" aria-labelledby="modalApprove" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <!-- Header berubah warna -->
                    <div class="modal-header @(isRejected ? "bg-danger" : "bg-success")">
                        <h5 class="modal-title mb-2 text-white" id="modalApprove">Detail Status</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                    </div>

                    <div class="modal-body">
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <ul class="list-group list-group-flush border-start border-3 @(isRejected ? "border-danger" : "border-success")">

                                    <!-- Request -->
                                    <li class="list-group-item ps-4 position-relative">
                                        <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-success p-2">
                                            <i class="bi bi-person-plus"></i>
                                        </span>
                                        <strong>Request By:</strong> @(rm.Users?.Name ?? "-")
                                        <br><small class="text-muted">@rm.CreatedAt</small>
                                    </li>

                                    <!-- Supervisor -->
                                    @{
                                        var approvedStatus = (rm.RequestStatus as IEnumerable<dynamic>)?
                                        .FirstOrDefault(s => s.Status?.ToString() == "SupervisorApproved");
                                    }
                                    <li class="list-group-item ps-4 position-relative">
                                        @if (approvedStatus != null)
                                        {
                                            <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-success p-2">
                                                <i class="bi bi-check-circle"></i>
                                            </span>
                                            <strong>Approved By Supervisor:</strong>
 
                                            @(approvedStatus.Users?.Name ?? "-")
                                            <br>
                                            <small class="text-muted">@approvedStatus.CreatedAt</small>
                                        }
                                        else
                                        {
                                            <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-secondary p-2">
                                                <i class="bi bi-clock"></i>
                                            </span>
                                            <strong>Approved By Supervisor:</strong>

                                            <i class="text-muted">-</i>
                                            <br>
                                            <small class="text-muted">-</small>
                                        }
                                    </li>

                                    <!-- Tim Fabricasi -->
                                    @{
                                        var fabApprove = (rm.RequestStatus as IEnumerable<dynamic>)?
                                        .FirstOrDefault(s => s.Status?.ToString() == "FabricationApproved");
                                    }
                                    <li class="list-group-item ps-4 position-relative">
                                        @if (fabApprove != null)
                                        {
                                            <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-success p-2">
                                                <i class="bi bi-check-circle"></i>
                                            </span>
                                            <strong>Approved By Fabrication Tim:</strong>

                                            @(fabApprove.Users?.Name ?? "-")
                                            <br>
                                            <small class="text-muted">@fabApprove.CreatedAt</small>
                                        }
                                        else
                                        {
                                            <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-secondary p-2">
                                                <i class="bi bi-clock"></i>
                                            </span>
                                            <strong>Approved By Fabrication Tim:</strong>

                                            <i class="text-muted">-</i>
                                            <br>
                                            <small class="text-muted">-</small>
                                        }
                                    </li>

                                    <!-- Fabrication -->
                                    @{
                                        var InFabrication = (rm.RequestStatus as IEnumerable<dynamic>)?
                                        .FirstOrDefault(s => s.Status?.ToString() == "FabricationStarted");
                                    }
                                    <li class="list-group-item ps-4 position-relative">
                                        
                                        @if (InFabrication != null)
                                        {
                                            <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-success p-2">
                                                <i class="bi bi-check-circle"></i>
                                            </span>
                                            <strong>Fabrication By:</strong>

                                            @(InFabrication.Users?.Name ?? "-")
                                            <br>
                                            <small class="text-muted">@InFabrication.CreatedAt</small>
                                        }
                                        else
                                        {
                                            <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-secondary p-2">
                                                <i class="bi bi-clock"></i>
                                            </span>
                                            <strong>Fabrication By:</strong>

                                            <i class="text-muted">-</i>
                                            <br>
                                            <small class="text-muted">-</small>
                                        }
                                    </li>

                                    <!-- Received -->
                                    @{
                                        var recivedStatus = (rm.RequestStatus as IEnumerable<dynamic>)?
                                        .FirstOrDefault(s => s.Status?.ToString() == "ResultPass" || s.Status?.ToString() == "ResultFail");
                                    }
                                    <li class="list-group-item ps-4 position-relative">
                                        @if (recivedStatus != null)
                                        {
                                            var isFail = recivedStatus.Status?.Contains("Fail", StringComparison.OrdinalIgnoreCase) == true;
                                            var badgeColor = isFail ? "bg-danger" : "bg-success";
                                            var borderColor = isFail ? "border-danger" : "border-primary";
                                            var textColor = isFail ? "text-danger" : "text-muted";

                                            <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle @badgeColor p-2">
                                                <i class="bi @(isFail ? "bi-x-circle" : "bi-check-circle")"></i>
                                            </span>
                                            <strong>Buy Off By:</strong>
 
                                            @(recivedStatus.Users?.Name ?? "-")
                                            <br>
                                            <small>@recivedStatus.CreatedAt</small>

                                            <div class="mt-2 border-start border-2 @borderColor ps-3">
                                                <small class="@(isFail ? "text-danger" : "")">
                                                    <strong>Result:</strong>
                                                    @System.Text.RegularExpressions.Regex.Replace(recivedStatus.Status ?? "-", "([a-z])([A-Z])", "$1 $2")
                                                </small>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-secondary p-2">
                                                <i class="bi bi-clock"></i>
                                            </span>
                                            <strong>Buy Off By:</strong>

                                            <i class="text-muted">-</i>
                                            <br>
                                            <small class="text-muted">-</small>
                                            <div class="mt-2 border-start border-2 border-secondary ps-3">
                                                <small><strong>Result:</strong> -</small>
                                            </div>
                                        }
                                    </li>


                                    <!-- Reject -->
                                    @if (isRejected && latestReject != null)
                                    {
                                        <li class="list-group-item ps-4 position-relative text-danger">
                                            <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-danger p-2">
                                                <i class="bi bi-x-circle"></i>
                                            </span>
                                            <strong>Rejected By:</strong> @(latestReject.Users?.Name ?? "-")
                                            <br><small class="text-muted">@latestReject.CreatedAt</small>

                                            @if (!string.IsNullOrEmpty((string)latestReject.Reason))
                                            {
                                                <div class="mt-2 border-start border-2 border-danger ps-3">
                                                    <small><strong>Reason:</strong> @latestReject.Reason</small>
                                                </div>
                                            }
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    }
}



<!-- Modal Detail -->
@if (ViewBag.ModalData != null)
{
    foreach (var rm in (IEnumerable<dynamic>)ViewBag.ModalData)
    {
        <div class="modal fade" id="modalDetail-@rm.Id" tabindex="-1" aria-labelledby="detailLabel-@rm.Id" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <!-- Modal Header -->
                    <div class="modal-header bg-gradient ">
                        <h5 class="modal-title" id="detailLabel-@rm.Id">Detail Data</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                    </div>

                    <!-- Modal Body -->
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped align-middle w-100">
                                <tbody>
                                    <tr>
                                        <th class="col-sm-4">Part Id</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @(rm.Id ?? Html.Raw("<span class='badge bg-danger'>-</span>"))
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="col-sm-4">Part Name</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @(rm.PartName ?? Html.Raw("<span class='badge bg-danger'>Belum di set</span>"))
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="col-sm-4">Part Code</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @(rm.PartCode ?? Html.Raw("<span class='badge bg-danger'>Belum di set</span>"))
                                        </td>
                                    </tr>

                                    <tr>
                                        <th class="col-sm-4">Machine Category</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @(rm.MachineCategories?.CategoryName ?? Html.Raw("<span class='badge bg-danger'>Belum di set</span>"))
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="col-sm-4">Raw Material</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @(rm.RawMaterials?.Name ?? Html.Raw("<span class='badge bg-danger'>Belum di set</span>"))
                                        </td>
                                    </tr>

                                    <tr>
                                        <th class="col-sm-4">External Cost ($)</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @(rm.ExternalFabCost != null ? rm.ExternalFabCost.ToString() : Html.Raw("<span class='badge bg-danger'>Belum di set</span>"))
                                        </td>
                                    </tr>

                                    <tr>
                                        <th class="col-sm-4">Fabrication Time</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @(rm.FabricationTime != null ? rm.FabricationTime.ToString() : Html.Raw("<span class='badge bg-danger'>Belum di set</span>"))
                                        </td>
                                    </tr>

                                    @if (rm.MachineCategoryId == 2)
                                    {
                                        <tr>
                                            <th class="col-sm-4">Weight</th>
                                            <td class="col-sm-8" style="word-break: break-word;">
                                                @(rm.Weight != null ? rm.Weight.ToString() : Html.Raw("<span class='badge bg-danger'>Belum di set</span>"))
                                            </td>
                                        </tr>
                                    }
                                    <tr>
                                        <th class="col-sm-4">Fabrication Unit</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @(rm.Unit ?? Html.Raw("<span class='badge bg-danger'>Belum di set</span>"))
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="col-sm-4">Saving Cost Calculation</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @if (rm.IsCalculateSaving)
                                            {
                                                <span class="badge bg-success">Yes</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">No</span>
                                            }
                                        </td>
                                    </tr>

                                    <tr>
                                        <th class="col-sm-4">Request Date</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @(rm.CreatedAt != null
                                                ? rm.CreatedAt.ToString("dd-MM-yyyy")
                                                : Html.Raw("<span class='badge bg-danger'>-</span>"))
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="col-sm-4">CRD</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @(rm.CRD != null
                                                ? rm.CRD.ToString("dd-MM-yyyy")
                                                : Html.Raw("<span class='badge bg-danger'>-</span>"))
                                        </td>
                                    </tr>

                                    <tr>
                                        <th class="col-sm-4">OCD</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @(rm.OCD != null
                                                ? rm.OCD.ToString("dd-MM-yyyy")
                                                : Html.Raw("<span class='badge bg-danger'>-</span>"))
                                        </td>
                                    </tr>

                                    <tr>
                                        <th class="col-sm-4">Design</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @if (!string.IsNullOrEmpty(rm.DesignPath))
                                            {
                                                <a href="@Url.Content(rm.DesignPath)" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Download</a>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="col-sm-4">Ref Drawing</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @if (!string.IsNullOrEmpty(rm.DrawingPath))
                                            {
                                                <a href="@Url.Content(rm.DrawingPath)" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye-fill"></i> View</a>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="col-sm-4">Ref Quotation</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @if (!string.IsNullOrEmpty(rm.QuantationPath))
                                            {
                                                <a href="@Url.Content(rm.QuantationPath)" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye-fill"></i> View</a>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="col-sm-4">Description</th>
                                        <td class="col-sm-8" style="word-break: break-word;">
                                            @(rm.Description ?? Html.Raw("<span class='badge bg-danger'>Belum di set</span>"))
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>
    }
}



@* Modal Approve *@
@if (Model != null && Model.Any())

{
}

<!-- Modal repeat -->
<div class="modal fade" id="modalRepeat" tabindex="-1" aria-labelledby="modalTambahLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/AdminSystem/RawMaterial/Create">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title mb-2" id="modalTambahLabel">Repeat Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="my-2" asp-for="ItemRequestId">Item Id</label>
                        <input name="SapId" class="form-control" type="number" readonly value="1000001234" />
                        <span asp-validation-for="SapId" class="text-danger"></span>
                    </div>
                    <div class="form-group mt-2">
                        <label class="my-2" asp-for="Quantity">Quantity</label>
                        <input name="Quantity" class="form-control" type="number" required placeholder="Masukan jumlah yg ingin di request..." />

                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const tableBody = document.querySelector('table.table tbody');
      const searchBox = document.getElementById('searchBox');
      const loadingText = document.getElementById('loadingText');
      const categoryFilter = document.querySelector('select[name="MachineCategoryId"]');
      const tabs = document.querySelectorAll('#statusTabs .nav-link');

      let currentStatusList = ['@ViewBag.CurrentStatus']; // ubah jadi array
      let debounceTimer = null;
      let loadingTimer = null;

      if (!tableBody || !searchBox) return;
      const initialHTML = tableBody.innerHTML;

      async function performSearch() {
        const keyword = searchBox.value.trim();
        const categoryId = categoryFilter ? categoryFilter.value : "";

        // Jika tidak ada filter apapun, kembalikan tampilan awal
        if (keyword.length === 0 && !categoryId && (!currentStatusList || currentStatusList.length === 0)) {
          tableBody.innerHTML = initialHTML;
          return;
        }

        clearTimeout(loadingTimer);
        loadingTimer = setTimeout(() => {
          if (loadingText) loadingText.style.display = 'block';
        }, 400);

        try {
          const url = new URL("/Requestor/MyRequest/Search", window.location.origin);
          if (keyword) url.searchParams.append("keyword", keyword);
          if (categoryId && categoryId !== "0") url.searchParams.append("categoryId", categoryId);

          // kirim semua status (bisa 1 atau banyak)
          currentStatusList.forEach(s => url.searchParams.append("status", s.trim()));

          const res = await fetch(url);
          if (!res.ok) throw new Error('Network response was not ok');
          const data = await res.json();
          console.log(data)
          clearTimeout(loadingTimer);
          if (loadingText) loadingText.style.display = 'none';

          if (!Array.isArray(data) || data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tidak ada data Request.</td></tr>`;
            return;
          }

          let html = '';
          data.forEach((rq, idx) => {
            const id = rq.id ?? '';
            let buttons = '';

            if (rq.status === "WaitingConfirmation") {
              buttons += `
                <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalPass-${id}">
                  <i class="bi bi-check"></i> Pass
                </button>
                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalFail-${id}">
                  <i class="bi bi-x-lg"></i> Fail
                </button>
                <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalDetail-${id}">
                  <i class="bi bi-info-circle"></i> Detail
                </button>
                <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalStatus-${id}">
                  <i class="bi bi-ticket-detailed"></i> Status
                </button>`;
            } else if (
              ["WaitingFabrication", "InFabrication", "WaitingApproval", "Maspro", "Fail", "Reject"].includes(rq.status)
            ) {
              buttons += `
                <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalDetail-${id}">
                  <i class="bi bi-info-circle"></i> Detail
                </button>
                <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalStatus-${id}">
                  <i class="bi bi-ticket-detailed"></i> Status
                </button>`;
            }

            html += `
              <tr>
                <td class="text-center">${idx + 1}</td>
                <td>${rq.id ?? '-'}</td>
                <td>${rq.partName ?? '-'}</td>
                <td>${rq.categoryName ?? '-'}</td>
                <td>${rq.createdAt ?? '-'}</td>
                <td class="text-center">${buttons}</td>
              </tr>`;
          });

          tableBody.innerHTML = html;
        } catch (err) {
          clearTimeout(loadingTimer);
          if (loadingText) loadingText.style.display = 'none';
          console.error('Search error:', err);
          tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Terjadi kesalahan saat mencari.</td></tr>`;
        }
      }

      // Debounce input
      searchBox.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(performSearch, 350);
      });

      // Filter kategori
      if (categoryFilter) categoryFilter.addEventListener('change', performSearch);

      // Tab change (Bootstrap event)
      tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', event => {
          const statusAttr = event.target.getAttribute('data-status');
          currentStatusList = statusAttr ? statusAttr.split(',').map(s => s.trim()) : [];
          performSearch();
        });
      });
    });
</script>