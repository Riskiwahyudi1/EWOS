@model List<EWOS_MVC.Models.ItemRequestModel>
@{
    ViewData["Title"] = "Dashboard";
}
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h5 class="my-3">Riwayat Request</h5>

<div class="d-flex align-items-center mb-3 gap-2">
    <div class="col-2 col-sm-2">
        @await Component.InvokeAsync("MachineCategories")
    </div>
    <input type="text" id="searchBox" class="form-control" placeholder="Search..." aria-label="Search" style="max-width: 300px;">
</div>
<style>
    .custom-tabs {
        border-bottom: 1px solid #dee2e6;
    }

        .custom-tabs .nav-link {
            border: none;
            color: #6c757d;
            background: transparent;
            font-weight: 500;
            position: relative;
            padding-bottom: 0.5rem;
        }

            .custom-tabs .nav-link.active {
                color: #0d6efd;
                background: transparent;
            }

                .custom-tabs .nav-link.active::after {
                    content: "";
                    position: absolute;
                    left: 0;
                    right: 0;
                    bottom: -1px;
                    height: 3px;
                    background-color: #0d6efd;
                    border-radius: 2px;
                }

            .custom-tabs .nav-link:hover {
                color: #0d6efd;
            }

            .custom-tabs .nav-link.active .badge {
                background-color: #0d6efd !important;
                color: #fff;
            }
</style>

@{
    var summary = ViewBag.StatusSummary as Dictionary<string, int>;
    int GetCount(string status) => summary != null && summary.ContainsKey(status) ? summary[status] : 0;

    var currentPath = Context.Request.Path.ToString().ToLower();
}

<ul class="nav nav-tabs custom-tabs justify-content-center" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link @(currentPath.Contains("waitingapproval") ? "active" : "")"
           href="/Requestor/MyRequest/WaitingApproval" role="tab">
            Waiting Approve
            @if (GetCount("WaitingApproval") > 0)
            {
                <span class="badge bg-danger rounded-pill ms-1">@GetCount("WaitingApproval")</span>
            }
        </a>
    </li>

    <li class="nav-item" role="presentation">
        <a class="nav-link @(currentPath.Contains("waitingfabrication") ? "active" : "")"
           href="/Requestor/MyRequest/WaitingFabrication" role="tab">
            Waiting Fabrication
            @if (GetCount("WaitingFabrication") > 0)
            {
                <span class="badge bg-danger rounded-pill ms-1">@GetCount("WaitingFabrication")</span>
            }
        </a>
    </li>

    <li class="nav-item" role="presentation">
        <a class="nav-link @(currentPath.Contains("onfabrication") ? "active" : "")"
           href="/Requestor/MyRequest/OnFabrication" role="tab">
            On Fabrication
            @if (GetCount("OnFabrication") > 0)
            {
                <span class="badge bg-danger rounded-pill ms-1">@GetCount("OnFabrication")</span>
            }
        </a>
    </li>

    <li class="nav-item" role="presentation">
        <a class="nav-link @(currentPath.Contains("waitingconfirmation") ? "active" : "")"
           href="/Requestor/MyRequest/WaitingConfirmation" role="tab">
            Waiting Confirmation
            @if (GetCount("WaitingConfirmation") > 0)
            {
                <span class="badge bg-danger rounded-pill ms-1">@GetCount("WaitingConfirmation")</span>
            }
        </a>
    </li>

    <li class="nav-item" role="presentation">
        <a class="nav-link @(currentPath.Contains("history") ? "active" : "")"
           href="/Requestor/MyRequest/History" role="tab">
            History
            @if (GetCount("History") > 0)
            {
                <span class="badge bg-danger rounded-pill ms-1">@GetCount("History")</span>
            }
        </a>
    </li>

    <li class="nav-item" role="presentation">
        <a class="nav-link @(currentPath.Contains("reject") ? "active" : "")"
           href="/Requestor/MyRequest/Reject" role="tab">
            Reject
            @if (GetCount("Reject") > 0)
            {
                <span class="badge bg-danger rounded-pill ms-1">@GetCount("Reject")</span>
            }
        </a>
    </li>
</ul>





<table class="table table-sm mt-3 table-striped table-bordered">
    <thead>
        <tr>
            <th class="text-center">No</th>
            <th>ID Request</th>
            <th>Item Name</th>
            <th>Machine Category</th>
            <th>Request Date</th>

            <th class="text-center">Action</th>
        </tr>
    </thead>
    <tbody>
        @{
            int index = 1;
        }

        @if (Model == null || !Model.Any())
        {
            <tr>
                <td colspan="12" class="text-center text-muted">Tidak ada data.</td>
            </tr>
        }
        else
        {
            foreach (var ir in Model)
            {
                <tr>
                    <td class="text-center">@index</td>
                    <td>@ir.Id</td>
                    <td>@ir.PartName</td>
                    <td>@ir.MachineCategories?.CategoryName</td>
                    <td>@ir.CreatedAt</td>
                    <td class="text-center">

                        <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalDetail-@ir.Id">
                            <i class="bi bi-info-circle"></i> Detail
                        </button>
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalStatus-@ir.Id">
                            <i class="bi bi-ticket-detailed"></i> Status
                        </button>
                    </td>
                </tr>
                index++;
            }
        }

    </tbody>
</table>

<nav aria-label="Page navigation example">
    <ul class="pagination justify-content-end">
        <li class="page-item disabled">
            <a class="page-link">Previous</a>
        </li>
        <li class="page-item"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item">
            <a class="page-link" href="#">Next</a>
        </li>
    </ul>
</nav>
@if (Model != null && Model.Any())
{
    foreach (var ir in Model)
    {
        // cek apakah status terakhir reject
        var isRejected = ir.Status?.Equals("Reject", StringComparison.OrdinalIgnoreCase) == true;
        var latestReject = ir.RequestStatus?
                .FirstOrDefault(s =>
                    s.Status.Contains("Reject", StringComparison.OrdinalIgnoreCase)
                );

        <div class="modal fade" id="modalStatus-@ir.Id" tabindex="-1" aria-labelledby="modalApprove" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <!-- Header berubah warna -->
                    <div class="modal-header @(isRejected ? "bg-danger" : "bg-success")">
                        <h5 class="modal-title mb-2 text-white" id="modalApprove">Detail Status</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                    </div>

                    <div class="modal-body">
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <ul class="list-group list-group-flush border-start border-3 @(isRejected ? "border-danger" : "border-success")">

                                    <!-- Request -->
                                    <li class="list-group-item ps-4 position-relative">
                                        <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-success p-2">
                                            <i class="bi bi-person-plus"></i>
                                        </span>
                                        <strong>Request By:</strong> @ir.Users.Name
                                        <br><small class="text-muted">@ir.CreatedAt</small>
                                    </li>

                                    <!-- Supervisor -->
                                    @{
                                        var approvedStatus = ir.RequestStatus.FirstOrDefault(s => s.Status == "SupervisorApproved");
                                    }
                                    <li class="list-group-item ps-4 position-relative">
                                        @if (approvedStatus != null)
                                        {
                                            <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-success p-2">
                                                <i class="bi bi-check-circle"></i>
                                            </span>
                                            <strong>Approved By Supervisor:</strong>
 
                                            @approvedStatus.Users?.Name
                                            <br>

                                            <small class="text-muted">@approvedStatus.CreatedAt</small>
                                        }
                                        else
                                        {
                                            <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-secondary p-2">
                                                <i class="bi bi-clock"></i>
                                            </span>
                                            <strong>Approved By Supervisor:</strong>

                                            <i class="text-muted">-</i>
                                            <br>

                                            <small class="text-muted">-</small>
                                        }
                                    </li>

                                    <!-- Fabrication -->
                                    <li class="list-group-item ps-4 position-relative">
                                        <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-secondary p-2">
                                            <i class="bi bi-hammer"></i>
                                        </span>
                                        <strong>Fabrication By:</strong> -
                                        <br><small class="text-muted">-</small>
                                    </li>

                                    <!-- Received -->
                                    <li class="list-group-item ps-4 position-relative">
                                        <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-secondary p-2">
                                            <i class="bi bi-person-check-fill "></i>
                                        </span>
                                        <strong>Received By:</strong> -
                                        <br><small class="text-muted">-</small>
                                    </li>

                                    
                                    @if (isRejected && latestReject != null)
                                    {
                                        <li class="list-group-item ps-4 position-relative text-danger">
                                            <span class="position-absolute top-50 start-0 translate-middle badge rounded-circle bg-danger p-2">
                                                <i class="bi bi-x-circle"></i>
                                            </span>
                                            <strong>Rejected By:</strong> @latestReject.Users?.Name
                                            <br><small class="text-muted">@latestReject.CreatedAt</small>
                                            @if (!string.IsNullOrEmpty(latestReject.Reason))
                                            {
                                                <div class="mt-2 border-start border-2 border-danger ps-3">
                                                    <small><strong>Reason:</strong> @latestReject.Reason</small>
                                                </div>
                                            }
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    }
}


<!-- Modal detail-->
@if (Model != null && Model.Any())
{
    foreach (var rm in Model)
    {
        <!-- Modal Detail -->
        <div class="modal fade" id="modalDetail-@rm.Id" tabindex="-1" aria-labelledby="detailLabel-@rm.Id" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title" id="detailLabel-@rm.Id">Detail Data</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                    </div>

                    <div class="modal-body">
                        <dl class="row">
                            <dt class="col-sm-4">Part Name</dt>
                            <dd class="col-sm-8">
                                @(!string.IsNullOrEmpty(rm.PartName)
                                                        ? rm.PartName
                                                        : Html.Raw("<span class='text-muted fst-italic'>Belum di set</span>"))
                                                                                                                          </dd>


                            <dt class="col-sm-4">Machine Category</dt>
                            <dd class="col-sm-8">
                                @(rm.MachineCategories.CategoryName != null
                                                        ? rm.MachineCategories.CategoryName
                                                        : Html.Raw("<span class='text-muted fst-italic'>Belum di set</span>"))
                                                                                                                          </dd>

                            <dt class="col-sm-4">External Cost ($)</dt>
                            <dd class="col-sm-8">
                                @(rm.ExternalFabCost.HasValue
                                                        ? rm.ExternalFabCost.ToString()
                                                        : Html.Raw("<span class='text-muted fst-italic'>Belum di set</span>"))
                                                                                                                          </dd>

                            <dt class="col-sm-4">Fabrication Time</dt>
                            <dd class="col-sm-8">
                                @(rm.FabricationTime.HasValue
                                                        ? rm.FabricationTime.ToString()
                                                        : Html.Raw("<span class='text-muted fst-italic'>Belum di set</span>"))
                    </dd>

                            @*         <dt class="col-sm-4">Raw Material</dt>
                                    <dd class="col-sm-8">
                                        @(rm.RawMaterials.Name != null
                                                                ? rm.RawMaterials.Name
                                                                : Html.Raw("<span class='text-muted fst-italic'>Belum di set</span>"))
                            </dd> *@

                    @if (rm.MachineCategoryId == 2)
                            {
                                <dt class="col-sm-4">Weight</dt>
                                <dd class="col-sm-8">
                                    @(rm.Weight != null
                                                            ? rm.Weight.ToString()
                                                            : Html.Raw("<span class='text-muted fst-italic'>Belum di set</span>"))
                    </dd>
                                        }

                    <dt class="col-sm-4">Part Code</dt>
                    <dd class="col-sm-8">
                        @(!string.IsNullOrEmpty(rm.PartCode)
                                                ? rm.PartCode
                                                : Html.Raw("<span class='text-muted fst-italic'>Belum di set</span>"))
                    </dd>

                            @* <dt class="col-sm-4">Link Quotation</dt>
                                <dd class="col-sm-8">
                            @if (!string.IsNullOrEmpty(rm.LinkQuantation))
                                    {
                                        <a href="@rm.LinkQuantation" target="_blank">klik disini</a>
                                    }
                                    else
                                    {
                                        @Html.Raw("<span class='text-muted fst-italic'>Belum di set</span>")
                                    }
                                </dd>

                                <dt class="col-sm-4">Link Drawing</dt>
                                <dd class="col-sm-8">
                                    @if (!string.IsNullOrEmpty(rm.LinkDrawing))
                                    {
                                        <a href="@rm.LinkDrawing" target="_blank">klik disini</a>
                                    }
                                    else
                                    {
                                        @Html.Raw("<span class='text-muted fst-italic'>Belum di set</span>")
                                    }
                                </dd>

                                <dt class="col-sm-4">Link ODC</dt>
                                <dd class="col-sm-8">
                                    @if (!string.IsNullOrEmpty(rm.LinkODC))
                                    {
                                        <a href="@rm.LinkODC" target="_blank">klik disini</a>
                                    }
                                    else
                                    {
                                        @Html.Raw("<span class='text-muted fst-italic'>Belum di set</span>")
                                    }
                                </dd>*@
                        </dl>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>
    }
}



@* Modal Approve *@
@if (Model != null && Model.Any())

{
    foreach (var rq in Model)

    {
        <!-- Modal Approve -->
        <div class="modal fade" id="modalApprove-@rq.Id" tabindex="-1" aria-labelledby="modalApproveLabel-@rq.Id" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form method="post" action="/AdminFabrication/NewRequest/Approve">

                        @Html.AntiForgeryToken()
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="modalApproveLabel-@rq.Id">Approve Request</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">


                            <div class="form-group mb-2">
                                <label for="estimation-@rq.Id">Estimasi Selesai</label>
                                <input type="date" class="form-control" id="estimation-@rq.Id" name="EstimationDone" required />
                            </div>

                            <input type="hidden" name="ItemRequestId" value="@rq.Id" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="submit" class="btn btn-success">Approve</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    }
}

<!-- Modal repeat -->
<div class="modal fade" id="modalRepeat" tabindex="-1" aria-labelledby="modalTambahLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/AdminSystem/RawMaterial/Create">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title mb-2" id="modalTambahLabel">Repeat Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="my-2" asp-for="ItemRequestId">Item Id</label>
                        <input name="SapId" class="form-control" type="number" readonly value="1000001234" />
                        <span asp-validation-for="SapId" class="text-danger"></span>
                    </div>
                    <div class="form-group mt-2">
                        <label class="my-2" asp-for="Quantity">Quantity</label>
                        <input name="Quantity" class="form-control" type="number" required placeholder="Masukan jumlah yg ingin di request..." />

                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>