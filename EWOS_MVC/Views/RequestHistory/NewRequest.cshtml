@model List<EWOS_MVC.Models.ItemRequestModel>
@{
    ViewData["Title"] = "History request";
}
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h5 class="mb-0">History New Request</h5>
</div>
<div class="d-flex align-items-center mb-3 gap-2">
    <div class="col-2 col-sm-2">
        @await Component.InvokeAsync("MachineCategories")
    </div>
    <input type="text" id="searchBox" class="form-control" placeholder="Search..." aria-label="Search" style="max-width: 300px;">
</div>

<div class="tab-wrapper">

    @{
        var summary = ViewBag.StatusSummaryNew as Dictionary<string, int>;
        int GetCount(string status) => summary != null && summary.ContainsKey(status) ? summary[status] : 0;
    }
    <!-- Tab Bar-->
    <ul class="nav nav-tabs justify-content-center" id="statusTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active"
            id="waitingapproval-tab"
            data-bs-toggle="tab"
            data-bs-target="#waitingapproval"
            data-status="WaitingApproval,FabricationApproval"
            type="button"
            role="tab">
                Waiting Approval
                @{
                    var waitingApprovalCount = GetCount("WaitingApproval");
                    var fabricationApprocalCount = GetCount("FabricationApproval");
                    var totalCountWaiting = waitingApprovalCount + fabricationApprocalCount;
                }
                @if (totalCountWaiting > 0)
                {
                    <span class="badge bg-danger rounded-pill">@totalCountWaiting</span>
                }

            </button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="waitingfabrication-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#WaitingFabrication"
                    data-status="WaitingFabrication"
                    type="button"
                    role="tab">
                Waiting Fabrication
                @if (GetCount("WaitingFabrication") > 0)
                {
                    <span class="badge bg-danger rounded-pill">@GetCount("WaitingFabrication")</span>
                }
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="infabrication-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#InFabrication"
                    data-status="InFabrication"
                    type="button"
                    role="tab">
                In Fabrication
                @if (GetCount("InFabrication") > 0)
                {
                    <span class="badge bg-danger rounded-pill">@GetCount("InFabrication")</span>
                }
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="waitingbuyoff-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#WaitingBuyOff"
                    data-status="WaitingBuyOff"
                    type="button"
                    role="tab">
                Waiting Buyoff
                @if (GetCount("WaitingBuyOff") > 0)
                {
                    <span class="badge bg-danger rounded-pill">@GetCount("WaitingBuyOff")</span>
                }
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="done-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#WaitingBuyOff"
                    data-status="Maspro,Fail"
                    type="button"
                    role="tab">
                Done
                @{
                    var masproCount = GetCount("Maspro");
                    var failCount = GetCount("Fail");
                    var totalConplate = masproCount + failCount;
                }
                @if (totalConplate > 0)
                {
                    <span class="badge bg-danger rounded-pill">@totalConplate</span>
                }
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="done-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#WaitingBuyOff"
                    data-status="Reject"
                    type="button"
                    role="tab">
                Reject
                @if (GetCount("Reject") > 0)
                {
                    <span class="badge bg-danger rounded-pill">@GetCount("Reject")</span>
                }
            </button>
        </li>
    </ul>
</div>

<table class="table table-sm table-striped table-bordered mt-3">
    <thead>
        <tr>
            <th class="text-center">No</th>
            <th>ID Request</th>
            <th>Requestor</th>
            <th>Item Name</th>
            <th>Machine Category</th>
            <th>Request Date</th>
            <th class="text-center">Action</th>
        </tr>
    </thead>
    <tbody>
        @{
            int index = 1;
        }

        @if (Model == null || !Model.Any())
        {
            <tr>
                <td colspan="12" class="text-center text-muted">Tidak ada data.</td>
            </tr>
        }
        else
        {
            foreach (var rm in Model)
            {
                <tr>
                    <td class="text-center">@index</td>
                    <td>@rm.Id</td>
                    <td>@rm.Users.Name</td>
                    <td>@rm.PartName</td>
                    <td>@rm.MachineCategories?.CategoryName</td>
                    <td>@rm.CreatedAt</td>
                       
                    <td class="text-center">

                        <!-- Detail -->
                        <button class="btn btn-warning btn-sm open-modal"
                                data-url="/RequestHistory/LoadData?Id=@rm.Id&amp;type=Detail">
                            Detail
                        </button>

                        <!-- Status -->
                        <button class="btn btn-info btn-sm open-modal"
                                data-url="/RequestHistory/LoadDataFab?Id=@rm.Id&amp;type=Status">
                            Progress
                        </button>

                    </td>

                </tr>
                index++;
            }
        }

    </tbody>
</table>
<nav aria-label="Page navigation example">
    <ul class="pagination justify-content-end">
        <li class="page-item disabled">
            <a class="page-link">Previous</a>
        </li>
        <li class="page-item"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item">
            <a class="page-link" href="#">Next</a>
        </li>
    </ul>
</nav>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tableBody = document.querySelector('table.table tbody');
        const searchBox = document.getElementById('searchBox');
        const categoryFilter = document.querySelector('select[name="MachineCategoryId"]');
        let currentStatusList = ['@ViewBag.CurrentStatus'];
        const loadingText = document.getElementById('loadingText');
        const tabs = document.querySelectorAll('#statusTabs .nav-link');

        if (!tableBody || !searchBox || !categoryFilter) return;

        const initialHTML = tableBody.innerHTML;
            let debounceTimer = null;
    let loadingTimer = null;

    async function performSearch() {
        const keyword = searchBox.value.trim();
        const categoryId = categoryFilter.value;

        if (keyword.length === 0 && !categoryId && (!currentStatusList || currentStatusList.length === 0)) {
            tableBody.innerHTML = initialHTML;
            return;
        }

        // Hapus timer sebelumnya
        clearTimeout(debounceTimer);

        // Set delay
        debounceTimer = setTimeout(async () => {
            try {
                // tampilkan indikator loading
                clearTimeout(loadingTimer);
                loadingTimer = setTimeout(() => {
                    if (loadingText) loadingText.style.display = 'block';
                }, 350);

                // Buat URL dan query
                const url = new URL("/RequestHistory/SearchNew", window.location.origin);
                if (keyword) url.searchParams.append("keyword", keyword);
                if (categoryId && categoryId !== "0") url.searchParams.append("categoryId", categoryId);

                // kirim semua status (bisa 1 atau banyak)
                currentStatusList.forEach(s => url.searchParams.append("status", s.trim()));
                const res = await fetch(url);
                if (!res.ok) throw new Error('Network response was not ok');

                const data = await res.json();
                clearTimeout(loadingTimer);
                if (loadingText) loadingText.style.display = 'none';

                if (!Array.isArray(data) || data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tidak ada data Request.</td></tr>`;
                    return;
                }

                // Generate HTML
                let html = '';
                data.forEach((rq, idx) => {
                    let buttons = "";
                        buttons += `
                             <button class="btn btn-warning btn-sm open-modal"
                                    data-url="/RequestHistory/LoadData?id=${rq.id}&type=Detail">
                                Detail
                            </button>


                            <button class="btn btn-info btn-sm open-modal"
                                    data-url="/RequestHistory/LoadDataFab?id=${rq.id}&type=Status">
                                Progress
                            </button>
                        `;

                    html += `
                        <tr>
                            <td class="text-center">${idx + 1}</td>
                            <td>${rq.id ?? ''}</td>
                            <td>${rq.users ?? ''}</td>
                            <td>${rq.partName ?? rq.PartName ?? ''}</td>
                            <td>${rq.categoryName ?? '-'}</td>
                            <td>${rq.createdAt ? new Date(rq.createdAt).toLocaleDateString('id-ID') : ''}</td>
                            <td class="text-center">${buttons}</td>
                        </tr>
                    `;
                });

                tableBody.innerHTML = html;

            } catch (err) {
                console.error('Search error:', err);
                if (loadingText) loadingText.style.display = 'none';
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Terjadi kesalahan saat mencari.</td></tr>`;
            }
        }, 200);
    }


        // Event search dengan debounce
        searchBox.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(performSearch, 350);
        });

        // Tab change (Bootstrap event)
          tabs.forEach(tab => {
            tab.addEventListener('shown.bs.tab', event => {
              const statusAttr = event.target.getAttribute('data-status');
              currentStatusList = statusAttr ? statusAttr.split(',').map(s => s.trim()) : [];
              performSearch();
            });
          });
       
        // Event filter kategori
        categoryFilter.addEventListener('change', performSearch);


    });
</script>