@using System.Globalization
@{
    ViewData["Title"] = "Dashboard";
}
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <!-- Header utama -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <h5 class="mb-0">Dashboard</h5>


    </div>

    <!-- Filter bar -->
    <div class="d-flex align-items-center mb-4 gap-2 flex-wrap">
        <div class="row gy-2 align-items-end">
            <div class="col-md-4 col-12">
                @await Component.InvokeAsync("YearsSetting")
            </div>
            <div class="col-md-8 col-12">
                @await Component.InvokeAsync("MachineCategories")
            </div>

        </div>

    </div>


    <!-- Tampilan chart -->
    <!-- Baris 1 -->
    <div style="display: flex; flex-wrap: wrap; gap: 30px; justify-content: space-around; margin-bottom: 30px;">

        <div style="flex: 1; min-width: 300px; max-width: 600px;" class="bg-light p-3 rounded shadow-sm">
            <h6 class="mb-4">Progress Monitoring</h6>
            <div style="display: flex; flex-wrap: wrap; justify-content: center;">
                <div id="fabricationCount" style="width: 260px; height: 260px;"></div>
                <div id="ProgressFabPie" style="width: 260px; height: 260px;"></div>
            </div>
        </div>

        <div style="flex: 1; min-width: 300px; max-width: 600px;" class="bg-light p-3 rounded shadow-sm">
            <h6 class="mb-4">Trend Request Fabrikasi</h6>
            <div id="barChart" style="width: 100%; height: 260px;" class=""></div>
        </div>

    </div>

    <!-- Baris 2 -->
    @{
        var currenYear = DateTime.Now.Year;
    }
    <div style="display: flex; flex-wrap: wrap; gap: 30px; justify-content: space-around; margin-bottom: 30px; ">
        <div style="flex: 1; min-width: 300px; " class="bg-white shadow-sm">
            <div class="d-flex flex-row justify-content-between py-3 px-3">
                <h6>Saving Cost Monitoring</h6>
                <h6>Potential Saving : <b><span id="potentialSavingText">@Model.potentialSaving.ToString("C2", new CultureInfo("en-US"))</b> </h6>
            </div>

            <div id="savingChart"></div>
        </div>

    </div>

    <!-- Baris 3 -->
    <div style="display: flex; flex-wrap: wrap; gap: 30px; justify-content: space-around; margin-bottom: 30px; ">
        <div style="flex: 1; min-width: 300px; " class="bg-white shadow-sm p-3">
            <h6>Machine Utilization</h6>
            <div id="machineUtilization"></div>
        </div>
    </div>

</div>

@section Scripts {

    <script>
            document.addEventListener('DOMContentLoaded', function () {

             // =============================
            // 1. TREN REQUEST FABRIKASI/MONTH
            // ===============================
             var requestCountOptions = {
                chart: { type: 'line', height: 250 },
                series: [
                    {
                        name: 'Quantity',
                        type: 'bar',
                        data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.qtyReqByMonth))
                    },
                    {
                        name: 'Kumulatif',
                        type: 'line',
                            data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.cumulativeReqQty))
                    }
                ],
                stroke: {
                    width: [0, 3], // 0 untuk bar, 3 untuk line
                    curve: ['straight', 'smooth']
                },
                dataLabels: {
                    enabled: true,
                    enabledOnSeries: [0,1]
                },
                xaxis: {
                    categories: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.monthReq))
                },
                yaxis: [
                    { title: { text: 'Quantity' } },
                    { opposite: true, title: { text: 'Kumulatif' } } // line chart di axis kanan
                ],
                tooltip: { shared: true }
            };

            // Render chart
            window.barChart = new ApexCharts(document.querySelector("#barChart"), requestCountOptions);
            window.barChart.render();


             // =======================================
            // 2.RADIAL CHART (fabrikasi count)
            // =========================================
            const totalRequest = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TotalRequest));
            const totalRequestDone = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TotalRequestDone));
            const totalRequestReject = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TotalReqReject));
            const totalWaiting = totalRequest - totalRequestDone - totalRequestReject;
            const percentWaiting = (totalWaiting / totalRequest) * 100;
            const percentReject = (totalRequestReject / totalRequest) * 100;
            const percentDone = (totalRequestDone / totalRequest) * 100;

                // fabrikasi count
                var fabricationCount = {
                series: [
                    100,
                    percentDone,
                    percentWaiting,
                    percentReject

                ],
                chart: {
                    height: 300,
                    type: 'radialBar',
                },
                plotOptions: {
                    radialBar: {
                        offsetY: 0,
                        startAngle: 0,
                        endAngle: 290,
                        hollow: {
                            margin: 5,
                            size: '30%',
                            background: 'transparent',
                        },
                        track: {
                            background: '#e0e0e0',
                            strokeWidth: '100%',   // tebal track
                            margin: 5,             // jarak track dengan bar
                        },
                        dataLabels: {
                            name: {
                                show: false
                            },
                            value: {
                                show: false
                            }
                        },
                        barLabels: {
                            enabled: true,
                            useSeriesColors: true,
                            offsetX: -8,
                            fontSize: '13px',

                            formatter: function(seriesName, opts) {
                                const index = opts.seriesIndex;

                                const realValues = [
                                    totalRequest,
                                    totalRequestDone,
                                    totalWaiting,
                                    totalRequestReject
                                ];

                                return seriesName + ": " + realValues[index];
                            }
                        },
                    }
                },
                colors: [
                '#1ab7ea',  // Total
                '#00e396',   // Done
                '#feb019',  // Waiting
                '#ff4560'  // Reject
                ],
                labels: [
                    'Total Request',
                    'Done',
                    'On Progress',
                    'Reject'
                ],
            };
                    window.fabricationChart = new ApexCharts(
                document.querySelector("#fabricationCount"),
                fabricationCount
            );
            window.fabricationChart.render();



            // =============================
            // 3. PERSENTASE PROGRESS FABRIKASI CHART
            // =============================
            var ProgressFabPie = {
                series: [totalWaiting, totalRequestDone],
                chart: {
                    type: 'donut',
                    height: 250
                },
                legend: {
                    position: 'bottom'
                    },
                labels: ['On Progress', 'Done'],

                responsive: [{
                breakpoint: 480,
                options: {
                    chart: {
                    width: 50
                    },
                    legend: {
                    position: 'bottom'
                    }
                }
                }]
            };

            window.progressFabChart = new ApexCharts( document.querySelector("#ProgressFabPie"), ProgressFabPie);
            window.progressFabChart.render();

             // =============================
            // 4. CALCULATION SAVING/MONTH
            // =============================
                const monthSaving = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.monthLabels));
                const savingByMonth = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.savingByMonth));
                const savingByCategory = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.savingByCategory));
                const savingCumulative = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.cumulative));
                const potentialSaving = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.potentialSaving));

                const usdFormatter = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD'
                });

                var savingData = {
                    series: [
                        {
                            name: 'CNC Milling',
                            type: 'column',
                            data: savingByCategory["1"]
                        },
                        {
                            name: '3D Printing',
                            type: 'column',
                            data: savingByCategory["2"]
                        },
                        {
                            name: 'Kumulatif (Line)',
                            type: 'line',
                            data: savingCumulative
                        }
                    ],
                    chart: {
                        height: 350,
                        type: 'line'
                    },
                    stroke: {
                        width: [0, 0, 3],
                        curve: ['straight', 'smooth', 'smooth']
                    },
                    dataLabels: {
                        enabled: true,
                        enabledOnSeries: [0, 1, 2],
                        formatter: function (val) {
                            return usdFormatter.format(val);
                        }
                    },
                    labels: monthSaving,
                    yaxis: [
                        {
                            title: {
                                text: 'Aktual (USD)'
                            },
                            labels: {
                                formatter: function (val) {
                                    return usdFormatter.format(val);
                                }
                            }
                        },
                        {
                            opposite: true,
                            title: {
                                text: 'Kumulatif (USD)'
                            },
                            labels: {
                                formatter: function (val) {
                                    return usdFormatter.format(val);
                                }
                            }
                        }
                    ],
                    tooltip: {
                        shared: true,
                        intersect: false,
                        y: {
                            formatter: function (val) {
                                return usdFormatter.format(val);
                            }
                        }
                    },
                    legend: {
                        position: 'bottom'
                    }
                };

                window.savingChart = new ApexCharts(
                    document.querySelector("#savingChart"),
                    savingData
                );
                window.savingChart.render();


             // =============================
            // 5. MACHINE UTILIZATION/WEEK
           // =============================
            const machineUtilizationByWeek = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.machineUtilization));

            // Ambil kategori week
            const chartWeeks = machineUtilizationByWeek.map(x => `Week ${x.Week}`);

            // Ambil persentase
            const chartPercents = machineUtilizationByWeek.map(x => x.Percent);

            // Chart Apex
            var machineUtilization = {
                series: [{
                    name: 'Machine',
                    data: chartPercents
                }],
                chart: {
                    height: 350,
                    type: 'bar',
                },
                plotOptions: {
                    bar: {
                        borderRadius: 10,
                        dataLabels: {
                            position: 'Top',
                        },
                    }
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val + "%";
                    },
                    offsetY: -20,
                    style: {
                        fontSize: '12px',
                        colors: ["#304758"]
                    }
                },
                xaxis: {
                    categories: chartWeeks,
                    position: 'Bottom',
                    axisBorder: { show: false },
                    axisTicks: { show: false },
                    crosshairs: {
                        fill: {
                            type: 'gradient',
                            gradient: {
                                colorFrom: '#D8E3F0',
                                colorTo: '#BED1E6',
                                stops: [0, 100],
                                opacityFrom: 0.4,
                                opacityTo: 0.5,
                            }
                        }
                    },
                    tooltip: { enabled: true }
                },
                yaxis: {
                    axisBorder: { show: false },
                    axisTicks: { show: false },
                    labels: {
                        show: false,
                        formatter: val => val + "%"
                    }
                },
                title: {
                    floating: true,
                    offsetY: 330,
                    align: 'center',
                    style: {
                        color: '#444'
                    }
                }
            };

            window.machineUtilChart = new ApexCharts( document.querySelector("#machineUtilization"), machineUtilization );
            window.machineUtilChart.render();

        });

    </script>
}

<script>
    // UNTUK UPDATE DATA SETELAH FILTER BY TAHUN DAN KATEGORI MESIN
    document.addEventListener("DOMContentLoaded", () => {

        async function loadChartData() {
            const yearSelect = document.querySelector('select[name="YearSettingId"]');
            const categorySelect = document.querySelector('select[name="MachineCategoryId"]');

            if (!yearSelect || !categorySelect) return;

            const year = yearSelect.value || 0;
            const categoryId = categorySelect.value || 0;

            try {
                const response = await fetch(`/Dashboard/Filter?year=${year}&categoryId=${categoryId}`);
                const data = await response.json();
                const totalRequest      = data.totalRequest ?? 0;
                const totalRequestDone  = data.totalRequestDone ?? 0;
                const totalReject  = data.totalReqReject ?? 0;
                const totalWaiting      = totalRequest - totalRequestDone - totalReject;
            // Hindari division by zero
            const safeDiv = totalRequest === 0 ? 1 : totalRequest;

            // =============================
            // 1. Hitung persentase
            // =============================

                const percentWaiting = ((totalWaiting / safeDiv) * 100);
                const percentReject = ((totalReject / safeDiv) * 100);
                const percentDone    = ((totalRequestDone / safeDiv) * 100);

                if (window.barChart) {
                    // Update series: bar + line
                    window.barChart.updateSeries([
                        {
                            name: "Quantity",
                            type: 'bar',
                            data: data.qtyReqByMonth
                        },
                        {
                            name: "Kumulatif",
                            type: 'line',
                            data: data.cumulativeReqQty
                        }
                    ], {
                        animate: true,
                        redraw: true,
                        dynamicAnimation: { enabled: true, speed: 800 }
                    });

                    // Update x-axis & stroke
                    window.barChart.updateOptions({
                        xaxis: { categories: data.monthReq },
                        stroke: {
                            width: [0, 3],       // 0 untuk bar, 3 untuk line
                            curve: ['straight', 'smooth']
                        },
                        yaxis: [
                            { title: { text: 'Quantity' } },
                            { opposite: true, title: { text: 'Kumulatif' } } // line chart di axis kanan
                        ],
                        tooltip: { shared: true }
                    });
                }

            // =============================
            // 2. UPDATE RADIAL CHART (fabrikasi count)
            // =============================
            if (window.fabricationChart) {
                window.fabricationChart.updateSeries([
                    100,
                    Number(percentDone),
                    Number(percentWaiting),
                    Number(percentReject)
                ]);

                // update label numbers (Total Request, Waiting, Done)
                    window.fabricationChart.updateOptions({
                        plotOptions: {
                            radialBar: {
                                barLabels: {
                                    enabled: true,
                                    formatter: function (seriesName, opts) {
                                        const index = opts.seriesIndex;
                                        const realValues = [
                                            totalRequest,
                                            totalRequestDone,
                                            totalWaiting,
                                            totalReject
                                        ];
                                        return seriesName + ": " + realValues[index];
                                    }
                                }
                            }
                        }
                    });
                }
                // =============================
                // 3. UPDATE DONUT CHART (ProgressFabPie)
                // =============================
                if (window.progressFabChart) {

                    window.progressFabChart.updateSeries([
                        totalWaiting,
                        totalRequestDone
                    ]);

                    window.progressFabChart.updateOptions({
                        labels: ['On Progress', 'Done'],
                        legend: {
                            position: 'bottom'
                        }
                    });
                }
                // =============================
                // 4. UPDATE SAVING BAR (savingData)
                // =============================
                  if (window.savingChart) {

                    const sbc = data.savingByCategory || {};
                    const cumulative = data.cumulative || [];
                    const months = data.monthLabels || [];
                    const potential = data.potentialSaving ?? 0;

                    let series = [];

                    if (!categoryId) {
                        // jika user belum memilih category, tampilkan semua category
                        for (const [cat, catData] of Object.entries(sbc)) {
                            const label = cat === "1" ? 'CNC Milling' :
                                          cat === "2" ? '3D Printing' : `Category ${cat}`;

                            series.push({
                                name: label,
                                type: 'column',
                                data: catData
                            });
                        }
                    } else {
                        // jika ada category yang dipilih, tampilkan cuma kategori itu
                        const selectedCat = categoryId.toString();
                        const selectedData = sbc[selectedCat] || [];
                        const label = selectedCat === "1" ? 'CNC Milling' :
                                      selectedCat === "2" ? '3D Printing' : `Category ${selectedCat}`;

                        series.push({
                            name: label,
                            type: 'column',
                            data: selectedData
                        });
                    }

                    // series kumulatif selalu ditampilkan
                    series.push({
                        name: 'Kumulatif (Line)',
                        type: 'line',
                        data: cumulative
                    });

                    // update chart series
                    window.savingChart.updateSeries(series);

                    // update chart options
                    window.savingChart.updateOptions({
                        stroke: {
                            width: [0, 3],
                            curve: ['straight', 'smooth']
                        },
                        labels: months
                    });

                    // update potential saving text
                    const formatted = potential.toLocaleString("en-US", {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    document.getElementById("potentialSavingText").innerText = `${formatted}`;
                }


                 // =============================
                // 5. UPDATE MACHINE UTILIZATION
               // =============================
                        if (window.machineUtilChart) {
                            const util = data.machineUtilization || [];
                            // labels week
                            const weeks = util.map(x => `Week ${x.week}`);

                            // data persen
                            const percents = util.map(x => x.percent ?? 0);

                            // update chart series
                            window.machineUtilChart.updateSeries([
                                {
                                    name: 'Machine Utilization',
                                    data: percents
                                }
                            ]);

                            // update x-axis
                            window.machineUtilChart.updateOptions({
                                xaxis: {
                                    categories: weeks
                                }
                            });
                        }



            } catch (error) {
                console.error("Error loading chart data:", error);
            }
        }

        // Event listener filter
        const yearSelect = document.querySelector('select[name="YearSettingId"]');
        const categorySelect = document.querySelector('select[name="MachineCategoryId"]');

        if (yearSelect) yearSelect.addEventListener("change", loadChartData);
        if (categorySelect) categorySelect.addEventListener("change", loadChartData);

    });
</script>

       