@model List<EWOS_MVC.Models.ItemFabricationModel>
@{
    ViewData["Title"] = "Fabrication History";
}
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h5 class="mb-0">Fabrication Monitoring</h5>
</div>

<!-- Filter bar -->
<!-- Bar 1: Tahun, Bulan, Minggu -->
<div class="container-fluid">
    <div class="row">
        <div class="col-md-6 col-12">
            <!-- Baris 1 -->
            <div class="row gy-2 align-items-end">
                <div class="col-md-4 col-12">
                    @await Component.InvokeAsync("MachineCategories")
                </div>
                <div class="col-md-4 col-12">
                    @await Component.InvokeAsync("MachineList")
                </div>
                <div class="col-md-4 col-12">
                    <input type="text" id="searchBox" class="form-control" placeholder="Search..." aria-label="Search">
                </div>
            </div>

            <!-- Baris 2 -->
            <div class="row gy-2 align-items-end mt-2">
                <div class="col-md-4 col-12">
                    @await Component.InvokeAsync("YearsSetting")
                </div>
                <div class="col-md-4 col-12">
                    @await Component.InvokeAsync("MonthSetting")
                </div>
                <div class="col-md-4 col-12">
                    @await Component.InvokeAsync("WeeksSetting")
                </div>

            </div>
        </div>
    </div>
</div>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger py-2" id="showError">@TempData["Error"]</div>
}
<hr class="my-4">
<div style="display: flex; gap: 30px; margin: 30px 0;">
    <!-- Machine Utilization -->
    <div style="flex: 0 0 300px; max-height: 40vh" class="bg-light shadow-sm py-4">
        <h6 class="text-center">Machine Utilization</h6>
        <div id="MachineUtilization" class=""></div>
    </div>

    <!-- List Item Table -->
    <div style="flex: 1 1 auto; py-4">
        <h6 class="text-center">List Item Fabrication</h6>
        <div style="overflow-x:auto;  min-height: 100vh;">
            <table class="table table-sm table-striped table-bordered">
                <thead>
                    <tr>
                        <th class="text-center">No</th>
                        <th>Item Name</th>
                        <th>Quantity</th>
                        <th>Saving Cost(USD)</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int index = 1;
                    }

                    @if (Model == null || !Model.Any())
                    {
                        <tr>
                            <td colspan="12" class="text-center text-muted">Tidak ada data.</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var ifab in Model)
                        {
                            <tr>
                                <td class="text-center">@index</td>
                                @{
                                    
                                    var statusEva = ifab.Status?.Trim().ToLower();
                                }
                                @if (statusEva == "evaluation")
                                {
                                    <td>Evaluasi @ifab.ItemRequest.PartName</td>
                                    <td>-</td>
                                    <td>-</td>

                                }
                                else
                                {
                                    <td>@ifab.ItemRequest.PartName</td>
                                    <td>@ifab.Quantity @ifab.ItemRequest.Unit</td>
                                    <td>@ifab.TotalSaving</td>

                                }
                                <td>@(ifab.FabricationTime.ToString() ?? "-") Hours</td>
                                <td>@ifab.Status</td>
                                  
                                <td class="text-center">
                                    @{
                                        var roles = (ViewBag.Roles as List<string>) ?? new List<string>();
                                        bool isAdminFabrication = roles.Contains("AdminFabrication");
                                        bool isEvaluate = ifab.RepeatOrderId == null;
                                        var status = ifab.Status?.Trim().ToLower();
                                    }
                                    <script>
                                        window.isAdminFabrication = @isAdminFabrication.ToString().ToLower();
                                    </script>
                                    <div class="dropstart">
                                        <button class="btn btn-info btn-sm dropdown-toggle"
                                                type="button"
                                                data-bs-toggle="dropdown"
                                                >
                                            Actions
                                        </button>

                                        <ul class="dropdown-menu p-2" style="min-width: 150px">

                                            @* === STATUS: ON PROGRESS === *@
                                            @if (status == "onprogress" && isAdminFabrication)
                                            {
                                                <li>
                                                    <button class="btn btn-primary btn-sm w-100 text-center open-modal"
                                                            data-url="/FabricationHistory/LoadData?id=@ifab.Id&type=Finish">
                                                        Done
                                                    </button>
                                                </li>

                                                <li class="mt-1">
                                                    <button class="btn btn-danger btn-sm w-100 text-center open-modal"
                                                            data-url="/FabricationHistory/LoadData?id=@ifab.Id&type=Cancel">
                                                        Cancel
                                                    </button>
                                                </li>

                                                @if (!isEvaluate)
                                                {
                                                    <li class="mt-1">
                                                        <button class="btn btn-warning btn-sm w-100 text-center open-modal"
                                                                data-url="/FabricationHistory/LoadData?id=@ifab.Id&type=Edit">
                                                            Edit
                                                        </button>
                                                    </li>
                                                }
                                                else
                                                {
                                                    <li class="mt-1">
                                                        <button class="btn btn-warning btn-sm w-100 text-center open-modal"
                                                                data-url="/FabricationHistory/LoadData?id=@ifab.Id&type=Evaluasi">
                                                            Evaluasi
                                                        </button>
                                                    </li>
                                                }
                                            }

                                            @* === STATUS: EVALUATION === *@
                                            @if (status == "evaluation" && isAdminFabrication)
                                            {
                                                <li class="mt-1">
                                                    <button class="btn btn-danger btn-sm w-100 text-center open-modal"
                                                            data-url="/FabricationHistory/LoadData?id=@ifab.Id&type=CancelEval">
                                                        Cancel Evaluation
                                                    </button>
                                                </li>
                                            }

                                            @* === STATUS: FABRICATION DONE + MACHINE CATEGORY 1 === *@
                                            @if (status == "fabricationdone" && isAdminFabrication && ifab.ItemRequest.MachineCategoryId == 1)
                                            {
                                                <li class="mt-1">
                                                    <button class="btn btn-warning btn-sm w-100 text-center open-modal"
                                                            data-url="/FabricationHistory/LoadData?id=@ifab.Id&type=updateCOC">
                                                        Edit
                                                    </button>
                                                </li>
                                            }

                                            <li class="mt-1">
                                                <button class="btn btn-info btn-sm w-100 text-center open-modal"
                                                        data-url="/FabricationHistory/LoadData?id=@ifab.Id&type=Detail">
                                                    Detail
                                                </button>
                                            </li>

                                        </ul>



                                    </div>
                                </td>

                            </tr>
                            index++;
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>

        const percentase = @((decimal)ViewBag.MachineUtilization);

         var MachineUtilization = {
                  series: [percentase],
                  chart: {
                  height: 200,
                  type: 'radialBar',
                },
                plotOptions: {
                  radialBar: {
                      track: {
                            background: '#d1d5db',
                            strokeWidth: '90%',
                            margin: 5
                        },

                    hollow: {
                      size: '60%',
                    }
                  },
                },
                labels: ['All Machines'],
                };

                var chart = new ApexCharts(document.querySelector("#MachineUtilization"), MachineUtilization);
                chart.render();
    </script>
}
<script src="~/js/General/fabricationHistory.js" defer></script>